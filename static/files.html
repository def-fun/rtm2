<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>show files</title>
    <script src="/static/jquery-1.12.4.min.js"></script>
    <script src="/static/echarts.js"></script>
</head>
<body>
<div id="main" style="width: 100%;height:30%;min-height: 300px"></div>

<script type="application/javascript">
    const myChart = echarts.init(document.getElementById('main'));
    myChart.showLoading({
        text: 'loading'
    });

    let xhr = new XMLHttpRequest();
    let timestamps = [];
    let timestamp_index = 0;
    let data;
    $(document).ready(function () {
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    data = JSON.parse(xhr.response).sort(sortByItem0);
                    for (let i = 0; i < data.length; i++) {
                        timestamps.push(data[i][0]);
                    }
                    timestamp_index = timestamps.length - 1;
                    option = {
                        title: {
                            text: 'Motion frames history ',
                            left: 'center'
                        },
                        toolbox: {
                            // feature: {
                            //     dataZoom: {
                            //        yAxisIndex: false
                            //   },
                            // saveAsImage: {
                            //   pixelRatio: 2
                            //      }
                            //}
                            feature: {
                                dataView: {
                                    show: true
                                },
                                restore: {
                                    show: true
                                },
                                dataZoom: {
                                    show: true
                                },
                                saveAsImage: {
                                    show: true
                                },
                            }
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        grid: {
                            x: 50,
                            x2: 30,
                        },
                        dataZoom: [{
                            type: 'inside'
                        }, {
                            type: 'slider'
                        }],
                        xAxis: {
                            axisLabel: {
                                textStyle: {
                                    color: 'rgba(2,1,29)',
                                    fontSize: 14,
                                }
                            },
                            type: 'time',
                            silent: false,
                            splitLine: {
                                show: false
                            },
                            splitArea: {
                                show: false
                            },
                        },
                        yAxis: {
                            type: 'value',
                            splitArea: {
                                show: false
                            },
                            min: 0,
                            axisLabel: {
                                textStyle: {
                                    color: 'rgba(2,1,29)',
                                    fontSize: 14,
                                }
                            },
                        },
                        series: [{
                            name: '帧数据',
                            type: 'bar',
                            barWidth: '100%',
                            barGap: '0%',
                            animation: false,
                            // Set `large` for large data amount
                            large: false,
                            data: data.map(function (item) {
                                return [item[0] * 1000, item[1]];
                            }),
                            markArea: {
                                silent: true,
                                data: [],
                                itemStyle: {
                                    color: '#c8edf9'
                                }
                            },
                            markLine: {
                                symbol: 'circle',
                                label: {
                                    position: 'end'
                                },
                                data: [{
                                    silent: false,
                                    lineStyle: {
                                        type: 'solid',
                                        color: '#1425FA',
                                    },
                                    xAxis: timestamps[timestamps.length - 1]
                                }]
                            }
                        }]
                    };
                    myChart.setOption(option, false, false);
                    myChart.hideLoading();
                    window.onresize = myChart.resize; // resize myChart when window size changed
                    myChart.on('click', function (obj) {
                        console.log(obj);

                        if (obj.componentType === 'series') {
                            timestamp_index = obj.dataIndex;
                            view_this(timestamp_index); // show frame and mark it in chart
                        }
                    });
                    view_this(timestamp_index);
                    plotDaysArea();
                }
            }

        };
        xhr.open('get', '/api/data', true);
        xhr.send(null);


    });

    function plotDaysArea() {
        let endDate = new Date(Math.max.apply(null, timestamps) * 1000);
        let startDate = new Date(Math.min.apply(null, timestamps) * 1000);
        let i = 0;
        for (let d = startDate; d <= endDate; d.setDate(d.getDate() + 1)) {
            i++;
            if (i % 2 === 0) {
                let day_stamp = new Date(d.toLocaleDateString()).getTime();
                console.log(i, d, day_stamp);
                option.series[0].markArea.data.push([{xAxis: day_stamp}, {xAxis: day_stamp + 86400000}]);
            }
        }
        myChart.setOption(option, false, false);
    }

    function view_this(timestamp_index) {
        option.series[0].markLine.data[0].xAxis = timestamps[timestamp_index];
        myChart.setOption(option, false, false);
        const sorted_stamps = data[timestamp_index][2];
        sorted_stamps.sort(sortByNum)
        const t = document.getElementById("images");
        t.innerHTML = formatDate(data[timestamp_index][0] * 1000) + " - " + sorted_stamps.length + "帧";
        for (let i = 0; i < sorted_stamps.length; i++) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            // td.innerHTML = "数据: " + data[timestamp_index].stamps[i];
            td.innerHTML = '<img  src="/frames/' + sorted_stamps[i] + '.jpg" alt="img">';
            tr.appendChild(td);
            t.appendChild(tr);
        }
    }


    function add0(m) {
        return m < 10 ? '0' + m : m
    }

    function formatDate(timestamp_ms) {
        const time = new Date(timestamp_ms);
        const y = time.getFullYear();
        const m = time.getMonth() + 1;
        const d = time.getDate();
        const h = time.getHours();
        const mm = time.getMinutes();
        const s = time.getSeconds();
        return y + '-' + add0(m) + '-' + add0(d) + ' ' + add0(h) + ':' + add0(mm) + ':' + add0(s);
    }

    function sortByNum(a, b) {
        return a - b
    }

    function sortByItem0(a, b) {
        return a[0] - b[0]
    }
</script>
<div>
    <table id="images" style="border: 1px">

    </table>
</div>
</body>
</html>
